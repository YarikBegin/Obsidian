[[JavaScript]]

Одна из особенностей нереляционных баз данных — отсутствие схемы. Схема — набор требований к данным: сколько полей у записи, какой длины может быть значение каждого поля, какие символы в нём допустимы.

Схема накладывает ограничения на данные, которые записаны в базу. Иногда это удобно, иногда нет. Современные NoSQL базы позволяют использовать схемы выборочно.

В MongoDB нет поддержки схем по умолчанию, но мы можем добавить их через Mongoose. Это нужно, чтобы проверять, соответствует ли документ схеме, прежде чем записывать его в БД. Фактически, мы сможем валидировать данные перед записью.

### Создадим схему

В REST API есть ресурсы — в проекте Mesto это пользователи и карточки. Каждый из ресурсов должен соответствовать задуманной структуре: например, у пользователя должно быть имя и информация о себе. Зададим схему для пользователя через Mongoose:

Скопировать кодJAVASCRIPT

```
// models/user.js
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: { // у пользователя есть имя — опишем требования к имени в схеме:
    type: String, // имя — это строка
    required: true, // оно должно быть у каждого пользователя, так что имя — обязательное поле
    minlength: 2, // минимальная длина имени — 2 символа
    maxlength: 30, // а максимальная — 30 символов
  },
  gender: {
    type: String, // гендер — это строка
    enum: ['м', 'ж', 'другой'] // gender может принимать одно из трёх значений
  },
  about: String, // тип — String
}); 
```

Такая схема говорит, что каждый пользователь в системе должен:

- обладать именем длиной от 2 до 30 символов;
- иметь гендер, который может принимать одно из трёх значений;
- иметь свойство about, причём строковое.

Иногда стандартных свойств схемы недостаточно. В Mongoose вы можете писать и более тонкие способы проверки данных. Для этого существует свойство `validate`. Это объект, свойствами которого являются:

- validator — функция валидации. Она должна возвращать булевое значение.
- message — сообщение об ошибке. Срабатывает в том случае, если функция валидации возвращает `false`.

Посмотрим на примере. В схему пользователя добавим свойство age, значение которого не должно быть меньше 18:

Скопировать кодJAVASCRIPT

```
// models/user.js
const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  name: { // у пользователя есть имя — опишем требования к имени в схеме:
    type: String, // имя — это строка
    required: true, // оно должно быть у каждого пользователя, так что имя — обязательное поле
    minlength: 2, // минимальная длина имени — 2 символа
    maxlength: 30, // а максимальная — 30 символов
  },
  gender: {
    type: String, // гендер — это строка
    enum: ['м', 'ж', 'другой'] // gender может принимать одно из трёх значений
  },
    age: { // у пользователя есть возраст
        type: Number, // возраст - число
        validate: { // опишем свойство validate
            validator(v) { // validator - функция проверки данных. v - значение свойства age
                return v >= 18; // если возраст меньше 18, вернётся false
            },
            message: 'Вам должно быть больше 18 лет!', // когда validator вернёт false, будет использовано это сообщение
        }
    },
  about: String, // тип — String
}); 
```

Это простая проверка данных. Более сложную можно сделать с помощью регулярных выражений. Об этом расскажем позже.

Вернёмся к типам данных. При создании схем мы будем применять 5 основных типов данных:

Скопировать кодJAVASCRIPT

```
String // строка
Number // число
Date // дата
Boolean // логическое: true или false
Array // массив 
```

### Свойства-объекты

Если свойство документа должно быть объектом, придётся воспользоваться методом `Schema` дважды:

- первый вызов нужен для создания схемы объекта: в нём мы описываем, какую структуру должно иметь свойство;
- второй — для передачи описанной схемы в свойство, которое должно иметь эту структуру:

Скопировать кодJAVASCRIPT

```
// models/user.js

const mongoose = require('mongoose');

// создадим схему документа «Домашнее животное»
const petSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    minlength: 2,
    maxlength: 30,
  },
  age: Number
});
// Когда схема готова, передадим её в свойство, которое должно соответствовать описанному шаблону:
const userSchema = new mongoose.Schema({
  ...
  pet: petSchema // опишем свойство pet этой схемой
}); 
```

### Свойства-массивы

Массивы нужны для хранения однотипных данных, поэтому описание схемы массива сводится к описанию шаблона элемента:

Скопировать кодJAVASCRIPT

```
// models/user.js

const mongoose = require('mongoose');

const userSchema = new mongoose.Schema({
  ...
  hobbies: [{ // описываем схему для одного элемента и заключаем её в квадратные скобки
    type: String,
    minlength: 2,
    maxlength: 30,
  }]
}); 
```

Эта схема определяет свойство hobbies: оно должно содержать массив строк. Каждая — длиной от 2 до 30 символов.

### Создание модели на основе схемы

Схемой мы определили, каким должен быть документ в базе. Перейдём к следующему этапу — созданию самих документов. Для этого на основе схемы строится модель.

Модель — это «обёртка» из методов вокруг схемы. Благодаря ей мы можем читать, добавлять, удалять и обновлять документы. В Mongoose модель создают методом `mongoose.model`.

Скопировать кодJAVASCRIPT

```
// models/user.js

const mongoose = require('mongoose');
// Опишем схему:
const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    minlength: 2,
    maxlength: 30,
  },
  about: String,
});

// создаём модель и экспортируем её
module.exports = mongoose.model('user', userSchema); 
```

Мы передали методу `mongoose.model` два аргумента: имя модели и схему, которая описывает будущие документы.

Аккуратно — тут можно запутаться. Первый аргумент — имя модели — должно быть существительным в единственном числе. Но Compass отображает его во множественном. Дело в том, что Mongoose автоматически добавляет букву "s" в конце имени коллекции:

![image](https://pictures.s3.yandex.net/resources/Screen_Shot_2019-09-22_at_13.25.28_1569338084.png)

### Создание моделей: резюме

1. Определите ресурсы API.
2. Опишите схемы этих ресурсов.
3. Создайте модели на основе схем.

Когда модели готовы, можно использовать их для взаимодействия с базой: создавать, изменять и удалять документы в ней. Этим и займёмся в следующем уроке.

### Дополнительные ссылки

Типы данных в схемах Mongoose: [https://mongoosejs.com/docs/schematypes.html](https://mongoosejs.com/docs/schematypes.html)

Больше про схемы: [https://mongoosejs.com/docs/guide.html](https://mongoosejs.com/docs/guide.html)