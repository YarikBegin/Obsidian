[[JavaScript]]

В предыдущем уроке мы создали модель. Она нужна, чтобы взаимодействовать с соответствующей коллекцией документов. Модель пользователя позволяет управлять коллекцией пользователей, модель карточек — коллекцией карточек.

С документом можно совершить одно из 4-х действий:

- создать (create),
- прочитать (read),
- обновить (update),
- удалить (delete).

Эти четыре действия обозначают аббревиатурой CRUD — по первым буквам английских названий. Разберём наиболее распространённые методы для каждого из этих действий.

### Создание документов — C

За это отвечает метод модели `create`. Он принимает на вход объект с данными, которые нужно записать в базу:

Скопировать кодJAVASCRIPT

```
// routes/users.js

/*
    всякий код для создания роутеров и т.п.
*/

// импортируем модель
const User = require('../models/user');

router.post('/', (req, res) => {
  const { name, about } = req.body; // получим из объекта запроса имя и описание пользователя

  User.create({ name, about }); // создадим документ на основе пришедших данных
}); 
```

Метод `create` может быть промисом — ему можно добавить обработчики `then` и `catch`. Так обычно и делают, чтобы вернуть клиенту данные или ошибку:

Скопировать кодJAVASCRIPT

```
// routes/users.js

/*
    всякий код для создания роутеров и т.п.
*/

const User = require('../models/user');

router.post('/', (req, res) => {
  const { name, about } = req.body;

  User.create({ name, about })
    // вернём записанные в базу данные
    .then(user => res.send({ data: user }))
    // данные не записались, вернём ошибку
    .catch(err => res.status(500).send({ message: 'Произошла ошибка' }));
}); 
```

### Чтение документов — R

Прочитать документ — значит найти его и получить данные. Искать можно разными способами. Три самых популярных: `findById`, `findOne` и `find`.

- Поиск конкретного документа. Метод `findById` ищет запись по идентификатору, то есть свойству `_id`, которое есть у каждого документа в MongoDB. Поэтому чтобы найти конкретный документ, передайте методу `findById` идентификатор в строковом виде:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // routes/users.js
    
      /*
          всякий код для создания роутеров и т.п.
      */
    
      const User = require('../models/user');
    
      router.get('/:id', (req, res) => {
        User.findById(req.params.id)
          .then(user => res.send({ data: user }))
          .catch(err => res.status(500).send({ message: 'Произошла ошибка' }));
      });
       
    ```
    
- Поиск одного документа по параметрам. Метод `findOne` возвращает первый документ, соответствующий запросу:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // найти первое совпадение с полем name равным "Стас Басов"
      User.findOne({ name: 'Стас Басов' });
       
    ```
    
- Поиск всех документов по параметрам. Метод `find` работает так же, как `findOne`, но возвращает все документы по запросу:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // найти всех тридцатилетних
      User.find({ age: 30 });
    
      // найти вообще всех
      User.find({});
       
    ```
    

### Обновление документов — U

Тут всё очень похоже на чтение. При обновлении мы находим запись и меняем её свойства.

- Обновление конкретной записи. Для этого есть метод `findByIdAndUpdate`, который принимает на вход идентификатор в строковом виде. Вторым параметром ему передают объект со свойствами, которые нужно обновить:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // routes/users.js
    
      // ...
    
      const User = require('../models/user');
    
      router.patch('/:id', (req, res) => {
        // обновим имя найденного по _id пользователя
        User.findByIdAndUpdate(req.params.id, { name: 'Виктор Гусев' })
          .then(user => res.send({ data: user }))
          .catch(err => res.status(500).send({ message: 'Произошла ошибка' }));
      });
       
    ```
    
- Поиск первого совпадения с запросом и обновление его. Для этого есть метод `findOneAndUpdate`, который принимает на вход два объекта: первый с параметрами поиска, второй — с данными, которые нужно обновить:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // найти первое совпадение с полем name равным "Стас Басов" и заменить имя на "Виктор Гусев"
      User.findOneAndUpdate({ name: 'Стас Басов' }, { name: 'Виктор Гусев' });
       
    ```
    
- Поиск совпадения с запросом и преобразование его. Аналогично можно превратить всех Стасов Басовых в Викторов Гусевых методом `update`:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // найти все совпадения с полем name равным "Стас Басов" и заменить имя на "Виктор Гусев"
      User.update({ name: 'Стас Басов' }, { name: 'Виктор Гусев' });
       
    ```
    

Есть тонкость в работе методов обновления: по умолчанию параметр, который получает на вход обработчик then — это документ до обновления:

Скопировать кодJAVASCRIPT

```
User.findByIdAndUpdate(req.params.id, { name: 'Виктор Гусев' })
  // user здесь — это документ до обновления
  .then(user => res.send({ data: user })); 
```

Это можно исправить. Поэтому третьим аргументом методы обновления документов принимают объект опций. Нас интересуют три из них:

|Опция|Что значит|Значение по умолчанию|
|---|---|---|
|new|передать обновлённый объект на вход обработчику then|false|
|runValidators|валидировать новые данные перед записью в базу|false|
|upsert|если документ не найден, создать его|false|

Благодаря объекту опций мы можем передать в `then` уже обновлённую запись. А также настроить валидацию и создать документ, если он не был найден:

Скопировать кодJAVASCRIPT

```
User.findByIdAndUpdate(
    req.params.id,
    { name: 'Виктор Гусев' },
    // Передадим объект опций:
    {
        new: true, // обработчик then получит на вход обновлённую запись
        runValidators: true, // данные будут валидированы перед изменением
        upsert: true // если пользователь не найден, он будет создан
    }
)
  .then(user => res.send({ data: user }))
  .catch(err => res.status(500).send({ message: "Данные не прошли валидацию. Либо произошло что-то совсем немыслимое" })); 
```

### Удаление документов — D

- **Удаление конкретной записи.** Для этого есть метод `findByIdAndRemove`:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // routes/users.js
    
      // ...
    
      const User = require('../models/user');
    
      router.delete('/:id', (req, res) => {
        User.findByIdAndRemove(req.params.id)
          .then(user => res.send({ data: user }))
          .catch(err => res.status(500).send({ message: 'Произошла ошибка' }));
      });
       
    ```
    
- **Удаление первого совпадения.** Этой цели служит `findOneAndRemove`:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // удалим пользователя на основе имени
      User.findOneAndRemove({ name: 'Стас Басов' });
       
    ```
    
- **Удаление всех совпадений.** Для этого вызывайте `deleteMany`:
    
    Скопировать кодJAVASCRIPT
    
    ```
      // удалим всех тридцатилетних
      User.deleteMany({ age: 30 });
       
    ```
    

## Ссылки

В этом уроке мы перечислили лишь основные методы, но у mongoose моделей методов очень много. Все их можно найти в официальной документации:

[https://mongoosejs.com/docs/api/model.html](https://mongoosejs.com/docs/api/model.html)