[[Продвинутый JavaScript]]

В прошлом уроке мы говорили о синхронных колбэках, в этом — переходим к асинхронным.

### Колбэк для загрузки изображений

Рассмотрим пример: нужно написать функцию для подгрузки изображений на сайт. Будем делать так: создадим изображение — элемент `<img>` — методом `document.createElement`. Затем назначим картинке атрибут `src`, чтобы браузер понял, откуда загружать изображение:

Скопировать кодJAVASCRIPT

```
function loadImage(imageUrl) {
  // создаём элемент изображения
  const img = document.createElement('img');
  img.src = imageUrl; // указываем путь к картинке

  return img;
}

// Теперь можно вставить картинку в разметку
const img = loadImage('https://yastatic.net/q/logoaas/v1/Практикум.svg');

document.body.append(img); 
```

Этот код будет исполняться так:

1.  Движок объявит функцию;
2.  Объявит переменную `img`;
3.  Запустит код функции `loadImage`;
4.  Создаст элемент изображения, запишет в него ссылку на картинку;
5.  Пока картинка загружается, создаст DOM-узел, где расположится изображение;
6.  Как только изображение загрузится, отрисует его.

В двух последних шагах кроется проблема. Когда движок создаст DOM-узел, вёрстка «дёрнется», освободив место для нового элемента. Затем, когда изображение загрузится, вёрстка дёрнется ещё раз при появлении картинки на экране. Если изображение не загрузится вовсе, пользователь увидит такой квадрат:

![image](https://pictures.s3.yandex.net/resources/sprint_9-14_1592576725.png)

Чтобы этого избежать, нужно создавать DOM-узел уже после того, как изображение загружено. И тут приходят на помощь колбэки.

У объекта изображения есть свойства `onload` и `onerror`. В них мы можем записать функции. Первая сработает, когда изображение загружено, вторая — если произошла ошибка. Запишем функции в соотвествующие свойства:

Скопировать кодJAVASCRIPT

```
// колбэк, который нужно выполнить после того
// как изображение загрузится
function imageLoadCallback(evt) {
  // после загрузки добавим элемент изображения в DOM
  document.body.append(evt.target);
}

// Функция для создания изображения
function loadImage(imageUrl, loadCallback) {
  const img = document.createElement('img');
  img.src = imageUrl;

  // Функция, которая записана в onload
  // будет вызвана после загрузки изображения
  img.onload = loadCallback;
}

// Теперь картинка появится в разметке только после загрузки
loadImage(
  'https://yastatic.net/q/logoaas/v1/Практикум.svg',
  imageLoadCallback
); 
```

Теперь вёрстка не дёрнется дважды — DOM-элемент создастся, только когда изображение подгружено.

Это пример работы с асинхронным кодом. Отрисовка изображений — часть браузерного API. И взаимодействие с этим API асинхронное: браузер запросил у сервера изображение, и пока оно идёт, занялся исполнением другого кода.

Нашей задачей было организовать работу с асинхронным кодом. Как-то сказать движку: «отрисуй изображение после того, как загрузишь его». Для этого мы записали функцию отрисовки изображения в свойство `onload`.

Колбэки — один из подходов организации работы с кодом. У такого подхода есть недостатки. О них в следующем уроке.