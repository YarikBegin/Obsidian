[[JavaScript]]

Пришло время создать простейший сервер. Для этого придётся сделать несколько шагов (довольно много, на самом деле). Так что не будем долго тянуть и приступим.

### Подключите API

Серверную программу нужно научить принимать сообщения, которые поступают на сетевую карту. В JavaScript нет такой встроенной возможности, зато она есть в специальном API из Node.js.

Имя этого API — `http`. Импортируйте его в код файла `index.js` командой `require`:

Скопировать кодJAVASCRIPT

```
const http = require('http'); 
```

### Создайте сервер

Для этого достаточно строчки кода:

Скопировать кодJAVASCRIPT

```
const http = require('http');

const server = http.createServer(); // создаём сервер 
```

Так мы даём библиотеке на C команду подключиться к сетевой карте и принимать сообщения. Теперь мы получаем к ним доступ из JavaScript-кода.

### Настройте порт

На компьютере может работать несколько программ, которые принимают сообщения, приходящие на сетевую карту. Чтобы это было возможно, у сетевой карты есть точки входа — порты. Всего их 65536.

Node.js надо знать, с какого порта принимать сообщения: для этого используют метод listen.

Укажите ноде принимать сообщения с 3000 порта:

Скопировать кодJAVASCRIPT

```
const http = require('http');

const server = http.createServer(); // создаём сервер

server.listen(3000); // будем принимать сообщения с 3000 порта 
```

### Установите ответ

Теперь мы можем принимать входящие сообщения. Но на них ещё нужно реагировать. Для этого функция createServer принимает колбэк — в нём и описывают код, который нужно запустить при получении запроса:

Скопировать кодJAVASCRIPT

```
const http = require('http');

// передадим обработчик
const server = http.createServer(() => {
  console.log('Пришёл запрос!');
});

server.listen(3000); 
```

Функция-обработчик, которую передал createServer, будет вызываться при каждом входящем запросе, пришедшем на 3000 порт. Сохраните этот код в файле `index.js` и запустите его в терминале:

![image](https://pictures.s3.yandex.net/resources/node-22_1568132771.png)

### Настройте запрос и ответ

Откройте в браузере адрес `http://localhost:3000`. В терминале появится сообщение — значит, наш сервер принимает запросы и реагирует на них. Но пока его реакция — всего лишь сообщение в консоли. Нам же нужно отправить пользователю ответ. Чтобы это сделать, сначала разберёмся с параметрами колбэка. Первый параметр — объект запроса, второй — объект ответа:

Скопировать кодJAVASCRIPT

```
const http = require('http');

const server = http.createServer((request, response) => {
  console.log('Пришёл запрос!');
  console.log(request);
  console.log(response);
});

server.listen(3000); 
```

### Объект запроса

Обычно его называют `request`, или сокращённо `req`. Вся информация о запросе содержится в свойствах объекта:

Скопировать кодJAVASCRIPT

```
// запустите этот файл и перейдите
// в браузере по адресу: http://localhost:3000/hello

const http = require('http');

const server = http.createServer((req, res) => {
  console.log(req.url); // /hello
  console.log(req.method); // GET
  console.log(req.headers); // здесь будут заголовки запроса
  console.log(req.body); // а здесь тело запроса, но у GET запроса его нет
});

server.listen(3000); 
```

### Объект ответа

Второй параметр обработчика называют `response`, или `res`. Он содержит свойства и методы для работы с ответом:

Скопировать кодJAVASCRIPT

```
// запустите этот файл и перейдите
// в браузере по адресу: http://localhost:3000

const http = require('http');

const server = http.createServer((req, res) => {
  res.statusCode = 200; // статус ответа
  res.statusMessage = 'OK'; // сообщение ответа
  res.setHeader('Content-Type', 'text/plain'); // добавить ответу заголовок

  res.write('Hello, '); // отправить часть ответа — строку "Hello, "
  res.write('world!'); // отправить часть ответа — строку "world!"

  res.end(); // закончить отправку ответа
});

server.listen(3000); 
```

Ответ от сервера получен! Мы отправляем его частями методом `res.write`.

Когда все данные получены, вызываем метод `res.end`. Так мы обозначаем, что ответ пришёл полностью. Обратите внимание: отправку всех частей ответа нужно прописать до вызова `res.end`.

А вот такой код приведёт к ошибке:

Скопировать кодJAVASCRIPT

```
const http = require('http');

const server = http.createServer((req, res) => {
  res.write('Hello, ');
  res.end();

  res.write('world!'); // вызовет ошибку
});

server.listen(3000); 
```

Код статуса ответа и заголовки можно передать одним методом — `writeHead`:

Скопировать кодJAVASCRIPT

```
const http = require('http');
const server = http.createServer((req, res) => {
    res.writeHead(200, {
        'Content-Type': 'text/html; charset=utf8'
    });
    // в методе end тоже можно передать данные
    res.end('<h1>Привет, мир!</h1>', 'utf8');
});

server.listen(3000);  
```

Не всегда кодировка по умолчанию — UTF-8, поэтому, чтобы не было проблем с отображением, нужно дописывать её вручную.

Вторым аргументом `end` принимает кодировку отправляемых данных. Каждый запрос должен заканчиваться вызовом этого метода.

### Пользуйтесь переменными окружения

Сервер готов, но у него есть одна проблема. Сейчас мы захардкодили (то есть явно указали в коде) входящий порт. Это не лучшая практика: входящие данные лучше передавать параметрами.

В Node.js это позволяют сделать переменные окружения. Они доступны из любой части программы, поэтому мы можем передать их при запуске сервера из терминала. Для этого перед командой запуска прописывают имена переменных и их значения:

Скопировать кодBASH

```
NODE_ENV=production node index.js
# NODE_ENV - имя переменной окружения, а production — её значение 
```

Внутри скриптов переменные окружения хранятся в объекте `process.env`:

Скопировать кодJAVASCRIPT

```
if (process.env.NODE_ENV !== 'production') {
  console.log('Код запущен в режиме разработки');
} 
```

Все переменные окружения принято называть заглавными буквами в snake case (слова разделены нижним подчёркиванием). В переменных окружения обычно передают конфигурационную информацию, необходимую приложению. Именно так мы укажем порт — при запуске сервера:

Скопировать код

```
PORT=3000 node app.js 
```