[[JavaScript]]

Бэкенд-разработчику важно понимать, как устроены компьютерные сети.

Наступит момент, когда вам потребуется защищать свой сервер от атак, настраивать шифрование и соединяться с серверами, используя различные протоколы — и всё это непременно с непроницаемым выражением лица, как у Джонни Ли Миллера в «Хакерах». Для этих задач (и чтобы добиться такой же мимики) надо понимать, какие агенты есть в интернете, как они взаимодействуют и по каким протоколам работают.

В этом уроке расскажем об общей структуре и технических принципах глобальной сети: никакой магии — только чёткий набор правил и комбинаций систем.

## Интернет с точки зрения компьютера

Вы сидите за компьютером и ищете решение очередной кодерской задачи. На столе лежит смартфон, на экране периодически всплывают уведомления в «Вотсапе» и «Телеграме». Открыл сайт, прочёл сообщение — так воспринимаем ситуацию мы. Но что происходит в это время с точки зрения устройств?

Поставим себя на их место.

![image](https://pictures.s3.yandex.net/resources/node-17_1568639709.png)

В вашей квартире наверняка есть роутер. Он обеспечивает телефону и компьютеру доступ в интернет, передавая им данные по кабелю или радиоволнам (если это Wi-Fi роутер). Роутер, в свою очередь, подключен к интернет-провайдеру, с помощью которого можно войти в глобальную сеть интернет.

У вас дома есть маленькая «локальная» сеть из роутера, компьютера, телефона и других устройств, которым вы дали доступ к сети (смарт-ТВ или смарт-утюг). Если не будет связи с провайдером — вы всё равно сможете работать внутри этой сети: при посредничестве роутера передавать файлы с компьютера на телефон, смотреть по ТВ фильмы с компьютерного жесткого диска или гладить бельё через веб-интерфейс.

Ваша домашняя сеть связана с сетью побольше: с сетью провайдера. Если провайдер вдруг утратит связь с глобальной сетью — вы (если это позволит провайдер) всё равно сможете обмениваться данными с теми компьютерами и серверами, которые подключены к провайдеру.

А пока у провайдера есть связь с внешним миром, он может передавать ваши запросы в другие компьютерные сети к разным серверам.

Получается, что интернет — децентрализованная совокупность связанных между собой больших и малых сетей.

![image](https://pictures.s3.yandex.net/resources/S12_1605869870.png)

![image](https://pictures.s3.yandex.net/resources/node-10_1568639731.png)

## Как найти друг друга в сети? IP-адрес

Что мы подразумеваем, когда говорим «подключиться к сети»?

Когда пользователь ищет что-то в интернете, устройство, будь то телефон или компьютер, отправляет запросы к различным серверам и получает от них ответы.

Интернет — огромная незримая «почтовая сеть», где по проводам ходят посылки с данными. Но чтобы доставить посылку, нужно знать «почтовый адрес» получателя — его IP-адрес, уникальный идентификатор устройства в сети. С его помощью вы сможете обмениваться данными с сервером.

![image](https://pictures.s3.yandex.net/resources/node-19_1568639757.png)

## Неравенство адресов: публичные и приватные IP

IP-адрес есть у каждого устройства в каждой сети. В зависимости от того, в сети какого уровня они используются, IP-адреса бывают публичными и приватными.

**Публичные («белые») IP-адреса** предназначены для адресации в глобальной сети, они уникальны.

При подключении к интернету роутер получает публичный IP-адрес от провайдера. Он уникален и не может совпадать с публичным IP-адресом другого устройства — как не может быть двух домов с абсолютно одинаковыми адресами (вы тоже подумали про фильм «Ирония судьбы или С лёгким паром»?) Ведь как иначе понять, куда отправлять данные?

**Приватные («серые») IP-адреса** уникальны только в пределах локальной сети (например, в пределах вашей квартиры). Телефон и компьютер, подключённые к одному роутеру, не могут иметь одинаковые IP-адреса. Но устройства, которые подключены к другому роутеру, (например, вашего соседа) могут быть с такими же IP-адресами, как и у вас.

Все пакеты данных из интернета приходят на роутер, а тот уже разбирается, какому устройству эти пакеты отдавать — компьютеру или телефону. Роутер запоминает, какое устройство из локальной сети отправило запрос в интернет и возвращает ответ именно ему. Программная служба, которая занимается этим процессом, называется NAT (Network Address Translation) и запущена на вашем роутере.

В актуальном стандарте адресации IPv4 может существовать небольшое число адресов: около четырёх миллиардов. Это адресное пространство сейчас почти исчерпано.

Чтобы решить эту проблему, придумали новый формат — IPv6. Комбинаций адресов этого формата значительно больше: 340 ундециллионов (число с 36 нулями). Сам адрес выглядит так: 2001:0db8:11a3:09d7:1f34:8a2e:07a0:765d.

## Где взять IP-адрес? DHCP-службы

При подключении к сети каждое устройство получает IP-адрес. За процедуру выдачи IP-адреса отвечает служба **DHCP** (Dynamic Host Configuration Protocol — «протокол динамической настройки узла»).

В домашней сети эта служба запущена на роутере. Если к вам в гости зайдёт знакомый и подключится к сети Wi-Fi, DHCP выдаст его устройству приватный IP-адрес.

Публичные адреса выдаёт специальный DHCP-сервер провайдера. Если вы перезагрузите домашний роутер, доступ в интернет появится не сразу. Эта задержка связана с обращением к DHCP-серверу — приходится ждать, пока роутер получит публичный IP-адрес.

IP-адрес устройства может меняться. Каждый раз, когда устройство подключается к сети, DHCP-служба роутера или провайдера выдаёт свободный адрес, который зарезервирован для этой сети. За каждым провайдером закреплён диапазон публичных IP-адресов, которые можно выдавать клиентам при подключении.

Если бы IP-адреса выдавали случайно, это привело бы к проблеме: вчера мы подключились к серверу [yandex.ru](http://yandex.ru/) и успешно искали ответы на вопросы Вселенной, но после перезагрузки сервера IP-адрес Яндекса поменялся и, выходит, мы не можем к нему подключиться. Что, если вчерашний IP Яндекса сегодня выдан онлайн-казино или порносайту?

Эта проблема решена. IP-адреса могут быть как динамическими, так и статическими. Поведение динамических адресов мы уже описали: вчера у вашего роутера был один IP-адрес, а сегодня, после перезагрузки, уже другой.

А вот статические IP-адреса навсегда закреплены за сервером и не меняются: IP-адрес можно «застолбить».

Многие провайдеры тоже предлагают клиентам услугу «статический IP»: купив такой адрес, вы сможете обращаться по IP к домашнему компьютеру.

А для приватных сетей зарезервированы несколько блоков адресов, которые не используются в пространстве публичных IP и распределением которых занимается администратор или DHCP-служба локальной сети.

## Поиск адреса по имени. DNS

Для доступа на сайты мы не вводим IP-адреса в браузер: как их вообще можно запомнить? Чтобы сделать адреса сетевых серверов более удобными придумали систему доменных имён — буквенных адресов, которыми мы и пользуемся. Мы пишем имя сайта — и специальная система DNS преобразует его в IP-адрес, понятный компьютерным системам.

Запрошенный адрес сайта передаётся провайдеру на специальный сервер — DNS (domain name system, «система доменных имён»). На нём хранится что-то вроде таблицы соответствия: какой IP-адрес за каким доменным именем закреплён.

Но провайдер не может собрать список таких соответствий для всего интернета, поэтому, если IP-адрес не удаётся найти на DNS-сервере провайдера, запрос передается «старшему товарищу» — корневому DNS-серверу или его зеркалу.

**Корневые DNS-серверы** — 13 «главных» DNS-серверов и их зеркала (копии), на которых хранится полный список соответствий «доменное имя — IP-адрес». Там обязательно найдётся нужное соответствие, результат вернётся на DNS провайдера и сохранится: в следующий раз уже не придётся обращаться на корневой сервер с тем же запросом. А запрос отправится по полученному IP-адресу.

## Новый адрес в интернете: пусть мир узнает обо мне

Возможно, вам уже сейчас необходимо доменное имя, чтобы разместить на нём «тот самый сайт, которого не хватает в интернете». Нужно обзавестись собственным доменом.

С точки зрения пользователя вы, возможно, уже знакомы с этой процедурой.

Ищете регистратора доменных имен, регистрируетесь, выбираете подходящее свободное доменное имя (что-нибудь простое и запоминающееся, например, poijafasdfhwed.io), заказываете, оплачиваете. Готово. Теперь вы владеете набором букв, которые никуда не ведут.

Чтобы разместить сайт (файлы и базу данных) в интернете, нужен **хостинг** — место на сервере. Вы покупаете и оплачиваете его отдельно — не обязательно там, где купили домен.

Для примера возьмём хостинг-сервис hosting.fake_._ Регистрируетесь на сервисе, выбираете тариф, оплачиваете — готово. После этого вы должны известить всемирную систему адресации (ту самую DNS, Domain Name System), что домен poijafasdfhwed.io размещён на серверах компании hosting.fake_._

Для этого на hosting.fake **вы** берёте **NS-адреса** (name servers) вашего хостинга — обычно их можно найти в разделе справки или настройки — и указываете их (например, ns1.hosting.fake_)_ в настройках домена в личном кабинете (там, где покупали доменное имя). Так вы связываете ваше доменное имя с хостингом. Это называется «делегировать домен на name servers хостинга».

Регистратор доменного имени передаёт эту информацию в систему DNS, и через некоторое время (обычно — от трёх часов до суток) данные, размещённые на хостинге, становятся доступны по доменному имени. Задержка связана с тем, что для передачи новой информации в DNS и распространения её по «зеркалам» DNS требуется время.

Интересно наблюдать, как в один и тот же момент домен откроется через одного провайдера (например, через вашего мобильного оператора), но не будет доступен через другого (например, домашнего провайдера). Информация распространяется не мгновенно и не равномерно: на всё требуется время, а магия вне Хогвартса запрещена.

После успешного добавления этой информации в DNS, пользователь набирает адрес poijafasdfhwed.io в браузере и запрос идёт к DNS провайдера:

— На каком IP этот домен? — Не знаю, спрошу у корневого, — отвечает DNS провайдера и отправляет запрос к географически ближнему корневому серверу или его «зеркалу». Тот отвечает: — Не знаю, но знаю того, кто знает, — и запрос отправляется дальше по цепочке. Путь приводит к нейм-серверу вашего хостинга, ns1.hosting.fake, а тот уже указывает на IP того сервера, где лежит ваш сайт. Готово, нашли.

Ответ сохраняется в DNS провайдера, и в следующий раз он уже ни у кого не будет спрашивать.

## Маршрут построен

Если бы ваш компьютер и сервер напрямую соединялись проводом, можно было бы отправлять данные прямо по нему. Но интернет — сложная сеть, где невозможно соединить каждый компьютер с каждым сервером. Данные приходится передавать через множество узлов, и каждый раз определять, какому именно узлу их отправить. Чтобы доставить данные, IP-адреса недостаточно — нужно определить маршрут.

Запрос от вашего роутера поступает на роутер провайдера, тот по адресу назначения запроса определяет оптимальный промежуточный узел, куда его нужно передать. Тот определяет следующий. И так — пока запрос не дойдёт до получателя: пакет данных может пройти через десятки серверов, прежде чем попадёт в цель.

Определение оптимального пути называется **маршрутизацией**. Решение «куда дальше отправить пакет» принимается на каждом промежуточном узле (включая домашний роутер).

Определить, через какие узлы прошёл запрос, можно с помощью терминала. Откройте его и введите команду:

Скопировать кодBASH

```
# Mac OS и Linux
traceroute yandex.ru 
```

Скопировать кодBASH

```
# Windows
tracert yandex.ru 
```

В командной строке вы увидите адреса серверов, через которые прошёл запрос, прежде чем достичь цели — сайта [yandex.ru](http://yandex.ru/).

Мы выяснили, как запрос идёт от нашего устройства до сервера назначения. Теперь разберёмся, что представляет собой этот запрос.

## Протокол передачи данных TCP

За передачу данных отвечает TCP (Transmission Control Protocol — «протокол управления передачей»).

**Протокол TCP** устанавливает связь с сервером по процедуре трёхэтапного согласования ("three way handshake"):

- клиент посылает на сервер специальный запрос на синхронизацию;
- сервер получает запрос и отвечает;
- клиент посылает еще один сигнал, чтобы подтвердить, что получил ответ сервера.

Связь считается установленной, если все три этапа прошли успешно. Если возникает ошибка, всё начинается заново.

После того как связь установлена, начинается передача данных. Сначала их разбивают на сегменты. Эти сегменты нужно доставить в целости и в нужном порядке. Если какие-то пакеты потерялись по пути к серверу, их отправляют заново. Если данные пришли не в том порядке, их упорядочивает сервер. Если бы этого механизма не было, в сообщениях в «Вотсапе» или «Телеграме» все буквы были бы перепутаны.

Из-за того, что данные приходят в том виде, в каком их отправили, TCP называют надёжным протоколом.

За надёжность приходится платить скоростью. Иногда это критично: например, при видеозвонках и трансляциях. Важно, чтобы данные приходили в режиме реального времени. И ничего страшного, если часть данных пропадёт: мы просто не увидим один из кадров, и звук исказится на долю секунды. Для такой коммуникации обычно применяют другой протокол передачи данных — **UDP.** Он куда быстрее, но менее надёжен.

## TCP/IP модель

Мы выяснили, что представляют собой IP и TCP по отдельности. На базе этих протоколов построили модель передачи данных через интернет — TCP/IP модель. Она включает в себя 4 уровня:

![image](https://pictures.s3.yandex.net/resources/node-18_1568640078.png)

Каждый уровень — это набор протоколов. Разберём их все:

- **Канальный.** Этот уровень ближе всего к железу. Он определяет, как разделить данные на пакеты и закодировать для передачи по сети. Он помогает упаковать информацию так, чтобы промежуточные узлы понимали, куда её следует отправить, а принимающая сторона смогла правильно её интерпретировать. Протоколы этого уровня: WLAN (для подключения по Wi-Fi) и Ethernet (по проводу).
- **Сетевой.** Данные закодированы, теперь необходимо выстроить логистику передачи пакетов, логику самой сети. Она строится на протоколе IP (Internet Protocol)_._ Этот протокол определяет, каким образом компьютеры объединяются в сеть и как осуществляется маршрутизация пакетов в сети. IP-адрес — часть протокола IP.
- **Транспортный.** Когда сеть готова, в ней можно обмениваться информацией. Для этого и нужен транспортный протокол. Он отвечает на вопрос: «Как передавать сообщения?», и включает в себя протоколы TCP (надежно, но неторопливо) и UDP (быстро, но с возможными потерями).
- **Прикладной.** Это уровень, с которым взаимодействует пользователь. Он включает в себя протоколы HTTP, FTP и SSH.

Данные, которые вы отправляете в запросе к поисковику или в сообщении в мессенджере, обрабатываются всеми уровнями: от канального до прикладного. Работа каждого уровня регулируется единым набором правил. Именно благодаря этим правилам мы можем пользоваться интернетом.