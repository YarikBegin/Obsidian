[[JavaScript]]

В прошлой теме мы генерировали JWT так:

Скопировать кодJAVASCRIPT

```
const token = jwt.sign({ _id: user._id }, 'super-strong-secret'); 
```

Как вы думаете, `'super-strong-secret'` — это хороший секретный ключ? На самом деле, не очень. Он состоит из осмысленных английских слов, такой секретный ключ подобрать проще, чем длинную комбинацию случайных символов. И тут возникает вопрос: какой длины ключа достаточно, чтобы его нельзя было подобрать?

## Криптостойкие псевдослучайные данные

Что это значит:

- **криптостойкость** означает, что данные генерируются алгоритмом, не поддающимся анализу. Проще говоря, на подбор ключа уйдут сотни лет;
- **псевдослучайность** означает, что символы очень похожи на случайные, но всё же сформированы математическим алгоритмом. Псевдослучайные данные гораздо проще генерировать, но почти также сложно подобрать. Поэтому они удовлетворяют нашей задаче.

Секретный ключ должен быть криптостойким и псевдослучайным.

Также нужно определиться с длиной пароля. Обычно сходятся на том, что оптимальный ключ должен быть последовательностью символов, которые в двоичном виде представляют собой цепочку нулей и единиц длиной 128 или 256 символов.

В Node.js есть встроенный модуль `crypto`, который генерирует такой ключ. На вход он принимает количество байт ключа, а не бит. Поскольку в одном байте 8 бит, для получения 128-битного ключа нужно передать методу `crypto` на вход `16`:

Скопировать кодJAVASCRIPT

```
const crypto = require('crypto'); // экспортируем crypto

const randomString = crypto
  .randomBytes(16) // сгенерируем случайную последовательность 16 байт (128 бит)
  .toString('hex'); // приведём её к строке

console.log(randomString); // 5cdd183194489560b0e6bfaf8a81541e 
```

Такой код писать не нужно, ведь ключ необходимо сгенерировать единожды. Можно просто сделать это в консоли.

Такое выражение сгенерирует 256-битный (32-байтный) ключ и выведет его в консоль:

Скопировать кодJAVASCRIPT

```
node -e "console.log(require('crypto').randomBytes(32).toString('hex'));" 
```

Этот ключ нельзя подобрать методом перебора и за сотню лет.

Конечно, есть вероятность, что завтра человечество изобретёт невероятно мощный компьютер, подбирающий такие ключи за секунды. Если это произойдёт, мы вас предупредим. А пока 256-битного ключа достаточно.

## Где хранить ключи

Когда ключ сгенерирован, его нужно сохранить. В прошлой теме, для примера мы держали его прямо в коде:

Скопировать кодJAVASCRIPT

```
// super-strong-secret хранится прямо в коде
const token = jwt.sign({ _id: user._id }, 'super-strong-secret'); 
```

**Никогда так не делайте**, иначе вся криптостойкость и псевдослучайность окажется бесполезной: ключ просто украдут. Обычно код хранят в удалённом репозитории, к которому есть доступ у множества людей: фронтенд- и бэкенд-разработчиков, продакт- и проджект-менеджеров, клиентов. Компьютер любого из них может быть взломан, а пострадают от этого пользователи.

Чем меньше людей имеют доступ к ключу, тем безопаснее. Поэтому секретный ключ хранят только на сервере, где запущено приложение.

Ключ заносят в переменные окружения. Для этого создают файл с расширением .env в корне проекта, и в нём объявляют env-переменные:

Скопировать код

```
NODE_ENV=production
JWT_SECRET=eb28135ebcfc17578f96d4d65b6c7871f2c803be4180c165061d5c2db621c51b 
```

Чтобы загрузить этот файл в Node.js, нужно установить в проект модуль `dotenv` и как можно раньше импортировать его в `app.js` таким образом:

Скопировать кодJAVASCRIPT

```
// app.js

require('dotenv').config(); 
```

После этого env-переменные из файла добавятся в `process.env`:

Скопировать кодJAVASCRIPT

```
// app.js

require('dotenv').config();

console.log(process.env.NODE_ENV); // production 
```

К ним можно обращаться при генерации токена:

Скопировать кодJAVASCRIPT

```
const { NODE_ENV, JWT_SECRET } = process.env;

const token = jwt.sign(
  { _id: user._id },
  NODE_ENV === 'production' ? JWT_SECRET : 'dev-secret'
); 
```

`.env` файл не нужно коммитить, поэтому его следует добавить `.gitignore`:

Скопировать кодJAVASCRIPT

```
.env 
```

Документация модуля `dotenv`: [https://www.npmjs.com/package/dotenv](https://www.npmjs.com/package/dotenv).