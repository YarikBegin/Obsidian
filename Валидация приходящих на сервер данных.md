[[JavaScript]]

Мы уже имплементировали валидацию, определив схему модели mongoose:

Скопировать кодJAVASCRIPT

```
const userSchema = new Schema({
  email: {
    type: String,
    required: true,
    unique: true,
    ...
}); 
```

Если оставить валидацию только на этом уровне, приложение будет легко атаковать, например, DDoS-атакой. Ведь чтобы такая валидация запустилась, должен запуститься и код контроллера. А он может непреднамеренно упасть, если клиент пришлёт не то тело запроса, которое мы от него ожидаем. Также в контроллере могут быть CPU-интенсивные операции, например хеширование пароля. Таким образом, злоумышленник может посылать много запросов, которые будут нагружать процессор или, хуже того, ронять приложение.

Поэтому принято валидировать входящий запрос и, если клиент присылает не то, что мы от него ждём, контроллер просто не запускается, а клиент получает ошибку. Для этого запрос описывают схемой.

## Joi и celebrate

**Joi** — популярная Node.js библиотека для валидации данных. Она позволяет описывать данные в интуитивно понятном виде:

Скопировать кодJAVASCRIPT

```
{
  body: Joi.object().keys({
    email: Joi.string().required().email(),
    password: Joi.string().required().min(8),
    name: Joi.string().required().min(2).max(30),
    age: Joi.number().integer().required().min(18),
    about: Joi.string().min(2).max(30),
  })
} 
```

Такое описание говорит, что `body` должно быть объектом с ключами:

- `email` — строка, обязательное поле, должно соответствовать паттерну почты;
- `password` — обязательная строка, минимум 8 символов;
- `name` — обязательная строка от 2 до 30 символов;
- `age` — число, целое, обязательное, минимально возможное значение — 18;
- `about` — строка от 2 до 30 символов.

Чтобы подключить валидацию Joi в качестве мидлвэр, мы будем использовать библиотеку **celebrate**. Перед использованием её нужно установить в проект, после чего импортировать и подключить как мидлвэр к роуту:

Скопировать кодJAVASCRIPT

```
const { celebrate, Joi } = require('celebrate');

router.post('/posts', celebrate({
  body: Joi.object().keys({
    title: Joi.string().required().min(2).max(30),
    text: Joi.string().required().min(2),
  }),
}), createPost); 
```

Такой мидлвэр валидирует тело запроса. В нём должно быть два поля — `title` и `text`. Если тело запроса не пройдёт валидацию, контроллер `createPost` вообще не запустится.

Кроме тела запроса, celebrate позволяет валидировать заголовки, параметры или `req.query`:

Скопировать кодJAVASCRIPT

```
const { celebrate, Joi } = require('celebrate');

router.delete('/:postId', celebrate({
  // валидируем параметры
  params: Joi.object().keys({
    postId: Joi.string().alphanum().length(24),
  }),
  headers: Joi.object().keys({
    // валидируем заголовки
  }),
  query: Joi.object().keys({
    // валидируем query
  }),
}), deletePost); 
```

По умолчанию Joi не допускает полей, которые не перечислены в объекте валидации. Чтобы изменить это поведение, нужно после вызова метода `keys` вызвать метод `unknown` с аргументом `true`:

Скопировать кодJAVASCRIPT

```
const { celebrate, Joi } = require('celebrate');

router.delete('/:postId', celebrate({
  headers: Joi.object().keys({
    // валидируем заголовки
  }).unknown(true),
}), deletePost); 
```

## Ошибки

Если запрос не проходит описанную валидацию, celebrate передаст его дальше, но не в контроллер, а в обработчик ошибки. Чтобы отправить клиенту ошибку, в celebrate есть специальный мидлвэр — `errors`:

Скопировать кодJAVASCRIPT

```
// app.js

const { errors } = require('celebrate');

// ...

// обработчики ошибок
app.use(errors()); // обработчик ошибок celebrate

// наш централизованный обработчик
app.use((err, req, res, next) => {
  // ...
}); 
```

`errors()` будет обрабатывать только ошибки, которые сгенерировал celebrate. Все остальные ошибки он передаст дальше, где их перехватит централизованный обработчик.

Статус ошибки, которую возвращает celebrate, — 400, а тело ответа имеет такой вид:

Скопировать кодJAVASCRIPT

```
{
    "statusCode": 400,
    "error": "Bad Request",
    "message": "child \"name\" fails because [\"name\" is required]",
    "validation": {
        "source": "body",
        "keys": [
            "name"
        ]
    }
} 
```

Поле `message` позволяет клиенту понять, что не так с его запросом. В данном случае celebrate сообщает, что в теле запроса отсутствует обязательное поле `name`.

## Ссылки

Документация Joi: [https://joi.dev/api/](https://joi.dev/api/).

Документация celebrate: [https://github.com/arb/celebrate](https://github.com/arb/celebrate).