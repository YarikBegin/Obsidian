[[JavaScript]]

При разработке мы часто пользуемся внешними инструментами: загружаем библиотеки и файлы стилей, подключаем зависимости. Такие инструменты удобны и упрощают жизнь разработчику. Но вместе с удобством приходят и потенциальные угрозы безопасности. В этом уроке разберём, какие и как с этим быть.

## Подключение внешних компонентов тегом `<script>`

Многие библиотеки подключаются тегом `<script>` со ссылкой на сайт производителя библиотеки:

Скопировать кодHTML

```
<script src="https://code.jquery.com/jquery.slim.min.js"></script> 
```

Такой подход опасен, поскольку мы не контролируем чужой сервер: файл может быть изменён, и в нём могут появиться уязвимости.

Первый шаг в защите от изменений — явно указывать версии подключаемых компонентов. Ссылка с указанием версии более надёжна, чем без указания:

|Менее безопасно|Более безопасно|
|---|---|
|`https://code.jquery.com/jquery.slim.min.js`|`https://code.jquery.com/jquery-3.4.1.slim.min.js`|

Ещё надежнее загружать код модуля в директорию с проектом и указывать локальный путь: `/vendor/jquery-3.4.1.slim.min.js`. Но если модуль большой, такой подход чреват не только дублированием кода, но и увеличением кодовой базы и, как следствие, ростом времени сборки проекта.

### Хеши против подмены файла

Файлы можно защитить ключом: так при загрузке браузер проверит, скачивает ли он тот самый файл, который мы указывали в процессе разработки. Для этого у тегов `<script>` и `<link>` есть атрибут `integrity`. В него записывают хеш-сумму — ключ, который рассчитывается, исходя из содержания файла. При скачивании файла с внешнего ресурса браузер рассчитает хеш-сумму файла и загрузит его, только если полученная сумма совпадает с той, что указана в атрибуте `integrity`. Это гарантирует, что файл не изменился.

Скопировать кодHTML

```
<script
  src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
  integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" 
  crossorigin="anonymous"
>
</script> 
```

Перед самой хеш-суммой через тире указывают алгоритм, по которому её следует рассчитывать, в нашем случае — `sha384`.

Хеш-сумму файла нужно заранее посчитать. Это можно сделать в специальном сервисе: [https://www.srihash.org/](https://www.srihash.org/).

Атрибут `crossorigin="anonymous"` означает, что при запросе не будут передаваться никакие данные пользователя, даже если он авторизован на том сервере, с которого запрашивается файл.

## Блокировка npm-зависимостей

Уязвимости могут появиться и в новых версиях npm-пакетов, подключённых к проекту. Поэтому зависимости также следует контролировать.

В материале о вебпаке мы описывали зависимости в файле `package.json`. Для этого в терминале мы вызывали команду `npm install`, и в `package.json` появлялась новая зависимость:

Скопировать кодJAVASCRIPT

```
"bcryptjs": "^2.4.3" 
```

Перед номером версии стоит шляпка `^`. Это значит, что если есть более новая версия с такими же первыми двумя цифрами и большей третьей, следует взять самую свежую версию. То есть установить не 2.4.3, а 2.4.4, если она доступна.

Что плохого в таком подходе:

- у разных разработчиков могут быть разные версии зависимостей;
- мы можем установить повышенную версию зависимости без своей на то воли.

Чтобы избежать подобного, в пятой версии npm появилась возможность зафиксировать зависимости. Для этого в специальном файле `package-lock.json` перечисляют те пакеты, которые нужно установить строго в указанных версиях. Это исключает апдейт версии без ведома разработчика.

Если у вас в проекте нет package-lock.json, проверьте версию npm командой `npm -v`. Если версия ниже пятой — обновите npm командой `npm install npm@latest -g`.

Если установлена пятая или более новая версия npm , но `package-lock.json` всё равно нет, вызовите в терминале команду:

Скопировать кодBASH

```
npm config set package-lock true 
```

или установите зависимости с ключом `--package-lock`:

Скопировать кодBASH

```
npm install --package-lock 
```

## Проверка безопасности зависимостей

В шестой версии npm появился инструмент для анализа безопасности пакетов. Чтобы воспользоваться им, запустите команду `npm audit`, находясь в папке проекта. Так npm сообщит о зависимостях, в которых есть уязвимости.

## Github Security Alert

Чтобы постоянно отслеживать уязвимости в пакетах, есть специальные инструменты. Они позволяют не вводить команду npm audit, поскольку берут мониторинг уязвимостей на себя.

Каждый сервис контроля версий разрабатывает собственный инструмент для контроля безопасности пакетов. Например, в Gitlab есть функция Dependency Scanning, а в Github — Security Alert.

Чтобы подключить Github Security Alert, зайдите в репозиторий на Github, откройте настройки (Settings) и поставьте соответствующую галочку:

![image](https://pictures.s3.yandex.net/resources/Screen_Shot_2019-10-08_at_23.01.05_1599396007.png)

Если одна из зависимостей имеет известную уязвимость, на главной странице репозитория появится уведомление:

![image](https://pictures.s3.yandex.net/resources/Screen_Shot_2019-10-08_at_17.30.41_1599396024.png)

Чтобы узнать, какая именно зависимость небезопасна, кликните на View security alert:

![image](https://pictures.s3.yandex.net/resources/Screen_Shot_2019-10-08_at_17.30.56_1599396050.png)

Также тут можно открыть подробности: в чём суть уязвимости и до какой версии следует обновиться.

![image](https://pictures.s3.yandex.net/resources/Screen_Shot_2019-10-08_at_23.11.44_1599396068.png)

## Базы данных уязвимостей

Угрозы безопасности также собирают в открытых базах данных. Любой компонент следует проверять на уязвимости по таким базам, чтобы оградить от злоумышленников свой проект.

[CVE Details](https://www.cvedetails.com/) — одна из крупнейших открытых баз данных общеизвестных уязвимостей. Все компоненты следует проверять по этой базе, прежде чем использовать их в проекте. Можно искать по имени компании, продукта или типам уязвимостей.

Разумеется, если компонента нет в базе, это не означает, что тот безопасен. Ведь в базу уязвимость попадает уже после того, как она была найдена. То есть тогда, когда ей кто-то воспользовался, и соответственно — пострадал.